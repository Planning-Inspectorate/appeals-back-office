import { HTTPError } from 'got';
import api from './back-office-api-client.js';

/**
 * Azure Functions v4 handler for malware detection events
 * @type {import('@azure/functions').EventGridHandler}
 */
export default async function (eventGridEvent, context) {
	if (!eventGridEvent?.data) {
		throw new Error('Received no input');
	}

	/**
	 * @type {{blobUri: string, scanResultType: string}}
	 */ //@ts-ignore
	const { blobUri, scanResultType } = eventGridEvent.data;

	const info = getInfoFromBlobURI(blobUri);
	if (!info) {
		throw new Error(
			`Not possible to extract info from blob with URI ${eventGridEvent.data.blobUri}`
		);
	}

	try {
		const res = await api.patch(info, statusFromScanResult(scanResultType), context);
		const { id } = res;
		context.info(`Document scan report for document: ${id}`);
	} catch (e) {
		if (e instanceof HTTPError) {
			context.error('Error reporting AV scan', {
				message: e.message,
				body: e.response?.body
			});
		} else {
			context.error('Error reporting AV scan', e);
		}
		throw e;
	}

	return {};
}

/**
 * @param {string} scanResult
 * @returns {string}
 * @throws {Error}
 * */
const statusFromScanResult = (scanResult) => {
	switch (scanResult) {
		case 'Malicious':
			return 'affected';
		case 'No threats found':
			return 'scanned';
		default:
			throw new Error(`Could not map scan result '${scanResult}' to a document status`);
	}
};

/**
 * @param {string} uri
 * @returns {{ id: string, reference: string, version: string} | null}
 * */
const getInfoFromBlobURI = (uri) => {
	const match = uri.match(/^.+\/appeals-bo-documents\/appeal\/(.+?)\/(.+?)\/v(\d+?)\//);
	const reference = match?.[1] ?? null;
	const id = match?.[2] ?? null;
	const version = match?.[3] ?? null;

	if (reference && id && version) {
		return {
			reference,
			id,
			version
		};
	}

	return null;
};
