import { HTTPError } from 'got';
import api from './back-office-api-client.js';

/**
 *
 * @param {import('@azure/functions').Context} context
 * @param {*} msg
 */
export default async function (context, msg) {
	if (!msg?.data) {
		throw new Error('Received no input');
	}

	const info = getInfoFromBlobURI(msg.data.blobUri);
	if (!info) {
		throw new Error(`Not possible to extract info from blob with URI ${msg.data.blobUri}`);
	}

	try {
		const res = await api.patch(info, statusFromScanResult(msg.data.scanResultType), context);
		const { id } = res;
		context.log.info(`Document scan report for document: ${id}`);
	} catch (e) {
		if (e instanceof HTTPError) {
			context.log.error('Error reporting AV scan', {
				message: e.message,
				body: e.response?.body
			});
		} else {
			context.log.error('Error reporting AV scan', e);
		}
		throw e;
	}
}

/**
 * @param {string} scanResult
 * @returns {string}
 * @throws {Error}
 * */
const statusFromScanResult = (scanResult) => {
	switch (scanResult) {
		case 'Malicious':
			return 'affected';
		case 'No threats found':
			return 'scanned';
		default:
			throw new Error(`Could not map scan result '${scanResult}' to a document status`);
	}
};

/**
 * @param {string} uri
 * @returns {{ id: string, reference: string, version: string} | null}
 * */
const getInfoFromBlobURI = (uri) => {
	const match = uri.match(/^.+\/appeals-bo-documents\/appeal\/(.+?)\/(.+?)\/v(\d+?)\//);
	const reference = match?.[1] ?? null;
	const id = match?.[2] ?? null;
	const version = match?.[3] ?? null;

	if (reference && id && version) {
		return {
			reference,
			id,
			version
		};
	}

	return null;
};
