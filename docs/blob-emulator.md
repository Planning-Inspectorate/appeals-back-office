# Setting up an Azure Blob Storage emulator

To run a local emulator, there are a number of required steps. In order to successfully write to the emulator, it is necessary to configure it over https, using a self-signed certificate, and with a Shared Access Signature (SAS).

1. The first step is to create a [local self-signed certificate](cert.md), ensuring it include bindings to `127.0.0.1` and `localhost`.

2. Once the certificate is created, it needs to be accessible by docker, in order to start the Azurite emulator with https.
   The following command will create a docker container running the emulator, mapping a local folder containing the certificate (in the example below, the command is run from the folder containing the certificate `certificate.pem`, which is mapped from a local folder (`./` in the example below) and accessible from the docker container locally in the `/workspace` folder):
   Default (see below for windows specific):

```shell
docker run -p 10000:10000 -p 10001:10001 -p 10002:10002 -v ./:/workspace --name pins_azurite -d mcr.microsoft.com/azure-storage/azurite azurite --silent --blobHost 0.0.0.0 --cert /workspace/certificate.pem --key /workspace/certificate-key.pem --oauth basic --skipApiVersionCheck
```

Windows:

```powershell
docker run -p 10000:10000 -p 10001:10001 -p 10002:10002 -v .\:/workspace --name pins_azurite -d mcr.microsoft.com/azure-storage/azurite azurite --silent --blobHost 0.0.0.0 --cert /workspace/certificate.pem --key /workspace/certificate-key.pem --oauth basic --skipApiVersionCheck
```

3. Once the emulator is running, it can be accessed by a client such as [Microsoft Azure Storage Explorer](https://azure.microsoft.com/en-gb/products/storage/storage-explorer). The self-signed certificate will not be trusted by default, so it can be added through the `Microsoft Azure Storage Explorer` edit menu.
4. Add the certificate by going into Edit>SSL Certificates>Import Certificates

5. Once the client is up and running, you should be able to connect to the emulator by adding a new storage account (right-click storage account) which uses a generic emulator connection, but ensuring that `Use HTTPS` is ticked. Please name this new account `pins_azurite`. You should now have a new account `pins_azurite (Key)` under `Storage Accounts`.

6. Once the new connection is created, please create (under `Blob containers`) a new container named `document-service-uploads` (this is where all the files will be stored).

7. Ensure CORS is properly configured on the blob container. In `Microsoft Azure Storage Explorer`, in the sidebar, expand `Storage Accounts > pins_azurite (Key)`, right click on `Blob Containers` and select `Configure CORS settings`. Add a new rule named `*` (or edit if already present), with the following settings:

```shell
Allowed Origins: *
Allowed Methods: GET,PUT,HEAD,DELETE
Allowed Headers: *
Exposed Headers: *
Max Age (in seconds): 5
```

Be sure to save the new rule.

7. Additionally, you'll need to create a SAS (Shared Access Signature) over that container, which will be required to connect the application. The SAS url (in the format of `https://127.0.0.1:10000/devstoreaccount1/document-service-uploads?sv=2018-03-28&st=2023-06-02T12%3A00%3A42Z&se=2027-01-03T13%3A00%3A00Z&sr=c&sp=rwl&sig=yO2DcTNPhe40gZORzH3TGJ%2FUa%2FvPBfkSXHBJI3g%2FLQI%3D&api-version=2021-10-04`) is generated by right-clicking the `document-service-uploads` container and using the "Get Shared Access Signature feature". We suggest to set a long lease on the signature (it is only for local development with the emulator), and to ensure basic CRUD is allowed (Read, Write, Delete, List).

> [!IMPORTANT]
> Ensure the `API Version` optional parameter has a value in a date format (like `2024-10-10`)

8. The final step is to configure the application to use the emulator. That is achieved by adding the following to `./appeals/web/.env` and `./appeals/api/.env`:

```shell
AZURE_BLOB_DEFAULT_CONTAINER=document-service-uploads
AZURE_BLOB_EMULATOR_SAS_HOST=[the SAS URL obtained in step 7]
AZURE_BLOB_STORE_HOST=https://127.0.0.1:10000/devstoreaccount1/
AZURE_BLOB_USE_EMULATOR=true
NODE_TLS_REJECT_UNAUTHORIZED=0
```

use `pins_azurite` instead of `127.0.0.1` in api
