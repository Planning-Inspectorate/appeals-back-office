parameters:
  - name: Environment
    type: string
    default: 'dev'
    values: ['dev', 'test']

  # üëá Toggle this in the Run pipeline UI
  - name: RunParallel
    type: boolean
    default: false   # nightly (scheduled) uses defaults ‚Üí single agent

  # üëá Folder/glob for non-parallel runs (no need to list every spec)
  - name: SpecsGlob
    type: string
    default: 'cypress/e2e/back-office-appeals/**/*.spec.js'

variables:
  - name: APP
    value: 'appeals'
  - group: e2e-${{ parameters.Environment }}

pr: none
trigger: none

schedules:
  - cron: "0 2 * * 1-5"
    displayName: Weekday test run
    branches:
      include: [main]
    always: true

jobs:
  - job: Run_Cypress_Tests_For_Appeals
    timeoutInMinutes: 90
    pool: pins-odt-agent-pool-tests

    strategy:
      # üü¢ PARALLEL: keep your existing groups
      ${{ if eq(parameters.RunParallel, true) }}:
        matrix:
          group1:
            SPEC: cypress/e2e/back-office-appeals/relatedAppeals.spec.js,cypress/e2e/back-office-appeals/issueDecision.spec.js,cypress/e2e/back-office-appeals/hearing.spec.js,cypress/e2e/back-office-appeals/reviewAppellantCase.spec.js
          group2:
            SPEC: cypress/e2e/back-office-appeals/manageCorrespondence.spec.js,cypress/e2e/back-office-appeals/manageDocsAppellantCase.spec.js,cypress/e2e/back-office-appeals/manageDocsLpaq.spec.js,cypress/e2e/back-office-appeals/nationalListSearch.spec.js,cypress/e2e/back-office-appeals/progressS20ToDecision.spec.js,cypress/e2e/back-office-appeals/progressS78ToDecision.spec.js,cypress/e2e/back-office-appeals/reviewLpaq.spec.js,cypress/e2e/back-office-appeals/s78ChangeTimetable.spec.js,cypress/e2e/back-office-appeals/scheduleSiteVisit.spec.js,cypress/e2e/back-office-appeals/startCase.spec.js,cypress/e2e/back-office-appeals/unlinkAppeals.spec.js,cypress/e2e/back-office-appeals/unrelateAppeals.spec.js,cypress/e2e/back-office-appeals/updateLpaqDueDate.spec.js,cypress/e2e/back-office-appeals/uploadDocsAppellantCase.spec.js,cypress/e2e/back-office-appeals/withdrawAppeal.spec.js,cypress/e2e/back-office-appeals/inquiry.spec.js
          group3:
            SPEC: cypress/e2e/back-office-appeals/addCorrespondence.spec.js,cypress/e2e/back-office-appeals/appellantCase.spec.js,cypress/e2e/back-office-appeals/assignUserToCase.spec.js,cypress/e2e/back-office-appeals/caseHistory.spec.js,cypress/e2e/back-office-appeals/caseNotes.spec.js,cypress/e2e/back-office-appeals/changeAppealType.spec.js,cypress/e2e/back-office-appeals/changeContact.spec.js,cypress/e2e/back-office-appeals/changeSiteVisit.spec.js,cypress/e2e/back-office-appeals/changeStartDate.spec.js,cypress/e2e/back-office-appeals/globalDateValidation.spec.js,cypress/e2e/back-office-appeals/issueDecisionInvalid.spec.js,cypress/e2e/back-office-appeals/linkAppeals.spec.js,cypress/e2e/back-office-appeals/lpaStatement.spec.js,cypress/e2e/back-office-appeals/manageDocsSupporting.spec.js

      # üü° SINGLE AGENT: run the whole folder via glob (no spec list)
      ${{ if eq(parameters.RunParallel, false) }}:
        matrix:
          single:
            SPEC: ''   # intentionally empty; we‚Äôll use SpecsGlob in the step

    steps:
      - task: NodeTool@0
        inputs:
          versionSpec: "22.x"
        displayName: "Install Node.js"

      - task: ShellScript@2
        inputs:
          scriptPath: 'appeals/e2e/install-chromium.sh'
        displayName: 'Install Chromium'
        condition: eq(variables['agent.os'], 'Linux')

      - task: Npm@1
        inputs:
          command: "install"
          workingDir: $(System.DefaultWorkingDirectory)/appeals/e2e
        displayName: "Install Dependencies"

      - script: |
          echo "Checking connectivity to back-office-appeals-dev..."
          curl -I https://back-office-appeals-dev.planninginspectorate.gov.uk/appeals-service/all-cases || echo "‚ùå curl failed"
        displayName: "Check app availability before Cypress"

      - script: |
          echo "Assigning per-worker index and jitter..."
          export CYPRESS_WORKER_INDEX=$(( $(System.JobPositionInPhase) - 1 ))
          export LOGIN_JITTER_MS=2000

          echo "Worker index: $CYPRESS_WORKER_INDEX"
          echo "Login jitter (ms): $LOGIN_JITTER_MS"

          # Choose spec arg: SPEC (parallel) or folder glob (single agent)
          SPEC_ARG="${SPEC}"
          if [ -z "$SPEC_ARG" ]; then
            SPEC_ARG='${{ parameters.SpecsGlob }}'
            echo "Running with folder glob: $SPEC_ARG"
          else
            echo "Running with explicit spec list"
            for spec in $(echo "$SPEC_ARG" | tr ',' ' '); do
              echo "- $spec"
            done
          fi

          npx cypress run --spec "$SPEC_ARG"
        workingDirectory: $(System.DefaultWorkingDirectory)/appeals/e2e
        env:
          TZ: 'Europe/London'
          BASE_URL: $(APPEALS_BASE_URL)
          CASE_TEAM_EMAIL: $(CASE_TEAM_APPEALS_EMAIL)
          CASE_ADMIN_EMAIL: $(CASE_ADMIN_APPEALS_EMAIL)
          INSPECTOR_EMAIL: $(INSPECTOR_APPEALS_EMAIL)
          VALIDATION_OFFICER_EMAIL: $(VALIDATION_OFFICER_EMAIL)
          USER_PASSWORD: $(USER_PASSWORD)
          HAPPY_PATH_EMAIL: $(HAPPY_PATH_EMAIL)
          CYPRESS_WORKER_INDEX: $(CYPRESS_WORKER_INDEX)
          LOGIN_JITTER_MS: $(LOGIN_JITTER_MS)
        displayName: "Run Cypress Tests"

      - task: PublishBuildArtifacts@1
        condition: failed()
        inputs:
          pathToPublish: 'appeals/e2e/cypress/screenshots'
          artifactName: 'FailedTests'
        displayName: "Publish Failed Tests Artifacts"
